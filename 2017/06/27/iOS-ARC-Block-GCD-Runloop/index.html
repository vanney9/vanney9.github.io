<!DOCTYPE HTML>
<html>
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">

    

    <title>关于ARC，Block以及GCD，runloop | Vanney</title>
    <meta name="author" content="Vanney">
    
    <meta name="description" content="前言最近又看了一遍 Objective-C高级编程 iOS与OS X多线程和内存管理 这本书。对一些问题有了一些新的认识。这篇文章将讲讲下面几个话题：

ARC，MRC 与 引用计数
Block的实现
GCD与runloop">
    
    
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

    <meta property="og:title" content="关于ARC，Block以及GCD，runloop"/>
    <meta property="og:site_name" content="Vanney"/>

    
    <meta property="og:image" content="undefined"/>
    

    <link rel="icon" type="image/png" href="/favicon.png">
    <link rel="alternate" href="/atom.xml" title="Vanney" type="application/atom+xml">
    <link rel="stylesheet" href="/css/lib/materialize.min.css">
    <link rel="stylesheet" href="/css/lib/font-awesome.min.css">
    <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">

    
        <link rel="stylesheet" href="/css/lib/atelier-dune-dark.css" type="text/css">
    
    <!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
</head>


<body>
    <img src="/weixin_favicon.png" style="position: absolute; left: -9999px; opacity: 0; filter: alpha(opacity=0);">

    <nav class="blue-grey">
    <div class="nav-wrapper">
        <a href="#" data-activates="main-menu" class="button-collapse">
            <i class="fa fa-navicon"></i>
        </a>
        <div class="">
            <a href="/" class="brand-logo hide-on-med-and-down">Vanney</a>
            <ul class="right hide-on-med-and-down">
                
                    <li>
                        <a class="menu-home " href="/" >
                            <i class="fa fa-home "></i>
                            
                            首页
                        </a>
                    </li>
                
                    <li>
                        <a class="menu-archive " href="/archives" >
                            <i class="fa fa-archive "></i>
                            
                            归档
                        </a>
                    </li>
                
                    <li>
                        <a class="menu-category category-menu" href="javascript:;" data-activates="category-menu" >
                            <i class="fa fa-bookmark "></i>
                            
                            分类
                        </a>
                    </li>
                
                    <li>
                        <a class="menu-about " href="/about" >
                            <i class="fa fa-user "></i>
                            
                            关于
                        </a>
                    </li>
                
                    <li>
                        <a class="menu-search modal-trigger " href="#search" >
                            <i class="fa fa-search "></i>
                            
                            搜索
                        </a>
                    </li>
                
            </ul>
            <div>
    <ul class="side-nav teal lighten-2" id="main-menu">
        
        <li class="side-user">
            <div class="row">
                <div class="col s4 no-padding">
                    <img class="avatar-image circle responsive-img" src="/lionheart/avatar.jpeg" alt="User Avatar">
                </div>
                <div class="info col s8 valign-wrapper no-padding">
                    <div class="valign">
                        <p class="name">vanney</p>
                        <p class="desc">iOS开发</p>
                    </div>
                </div>
            </div>
        </li>
        

        
            <li class="no-padding">
                <a class="waves-effect menu-home " href="/" >
                    <i class="fa fa-home "></i>
                    
                    首页
                </a>
            </li>
        
            <li class="no-padding">
                <a class="waves-effect menu-archive " href="/archives" >
                    <i class="fa fa-archive "></i>
                    
                    归档
                </a>
            </li>
        
            <li class="no-padding">
                <a class="waves-effect menu-category category-menu" href="javascript:;" data-activates="category-menu" >
                    <i class="fa fa-bookmark "></i>
                    
                    分类
                </a>
            </li>
        
            <li class="no-padding">
                <a class="waves-effect menu-about " href="/about" >
                    <i class="fa fa-user "></i>
                    
                    关于
                </a>
            </li>
        
            <li class="no-padding">
                <a class="waves-effect menu-search modal-trigger " href="#search" >
                    <i class="fa fa-search "></i>
                    
                    搜索
                </a>
            </li>
        
    </ul>

    <ul class="side-nav teal lighten-2" id="category-menu">
    

            

            <li class="collapse-level-0" collapse-level="0">
                <a class="no-padding" href="/categories/杂七杂八/">
                    杂七杂八 <span class="right">9 篇</span></a>
                </a>
            </li>

        

            <li class="collapse-level-0" collapse-level="0">
                <a class="no-padding" href="/categories/iOS/">
                    iOS <span class="right">27 篇</span></a>
                </a>
            </li>

        

            <li class="collapse-level-0" collapse-level="0">
                <a class="no-padding" href="/categories/读书笔记/">
                    读书笔记 <span class="right">13 篇</span></a>
                </a>
            </li>

        

            <li class="collapse-level-0" collapse-level="0">
                <a class="no-padding" href="/categories/server/">
                    server <span class="right">2 篇</span></a>
                </a>
            </li>

        

    </ul>
</div>

        </div>
    </div>
</nav>

<div id="search" class="modal search-modal">
    <div class="row">
        <div class="input-field col s12">
              <input id="search-input" type="text">
              <label for="search-input">搜索</label>
        </div>

    </div>
    <div id="search-result" class="search-result col s12">

    </div>
</div>


    <main>
        <div class="container main-container">
    <nav class="page-nav hide-on-small-only">
    <div class="nav-wrapper teal lighten-2">
        <span class="breadcrumb">当前位置（分类目录）</span>
        
            
    
    
    <a class="breadcrumb" href="/categories/iOS/">iOS</a>


        

        
    </div>
</nav>

<article>
    <div class="card">
        <div class="card-content">
            

            <div class="article-title">
                
    
        <h1>关于ARC，Block以及GCD，runloop</h1>
    


            </div>
            <time class="teal-link-context" datetime="2017-06-27T11:51:42.000Z"><a href="/2017/06/27/iOS-ARC-Block-GCD-Runloop/">2017-06-27</a></time>

            <span id="busuanzi_container_page_pv" class="read-times-container">
    <!--<i class="fa fa-eye"></i>-->
    <span id="busuanzi_value_page_pv"></span>
</span>

            

            <div class="toc teal-link-context hide-on-med-and-down">
    <ol class="section table-of-contents"><li class="section table-of-contents-item section table-of-contents-level-2"><a class="section table-of-contents-link" href="#前言"><span class="section table-of-contents-text">前言</span></a></li><li class="section table-of-contents-item section table-of-contents-level-2"><a class="section table-of-contents-link" href="#ARC-MRC-与-引用计数"><span class="section table-of-contents-text">ARC, MRC 与 引用计数</span></a><ol class="section table-of-contents-child"><li class="section table-of-contents-item section table-of-contents-level-3"><a class="section table-of-contents-link" href="#引用计数"><span class="section table-of-contents-text">引用计数</span></a></li><li class="section table-of-contents-item section table-of-contents-level-3"><a class="section table-of-contents-link" href="#手动引用计数-MRC"><span class="section table-of-contents-text">手动引用计数 MRC</span></a><ol class="section table-of-contents-child"><li class="section table-of-contents-item section table-of-contents-level-4"><a class="section table-of-contents-link" href="#alloc-new-copy-mutableCopy"><span class="section table-of-contents-text">alloc/new/copy/mutableCopy</span></a></li><li class="section table-of-contents-item section table-of-contents-level-4"><a class="section table-of-contents-link" href="#retain"><span class="section table-of-contents-text">retain</span></a></li><li class="section table-of-contents-item section table-of-contents-level-4"><a class="section table-of-contents-link" href="#release"><span class="section table-of-contents-text">release</span></a></li><li class="section table-of-contents-item section table-of-contents-level-4"><a class="section table-of-contents-link" href="#examples"><span class="section table-of-contents-text">examples</span></a><ol class="section table-of-contents-child"><li class="section table-of-contents-item section table-of-contents-level-5"><a class="section table-of-contents-link" href="#autorelease函数"><span class="section table-of-contents-text">autorelease函数</span></a></li><li class="section table-of-contents-item section table-of-contents-level-5"><a class="section table-of-contents-link" href="#array类对象"><span class="section table-of-contents-text">array类对象</span></a></li></ol></li><li class="section table-of-contents-item section table-of-contents-level-4"><a class="section table-of-contents-link" href="#MRC总结"><span class="section table-of-contents-text">MRC总结</span></a></li></ol></li><li class="section table-of-contents-item section table-of-contents-level-3"><a class="section table-of-contents-link" href="#自动引用计数-ARC"><span class="section table-of-contents-text">自动引用计数 ARC</span></a><ol class="section table-of-contents-child"><li class="section table-of-contents-item section table-of-contents-level-4"><a class="section table-of-contents-link" href="#strong"><span class="section table-of-contents-text">__strong</span></a><ol class="section table-of-contents-child"><li class="section table-of-contents-item section table-of-contents-level-5"><a class="section table-of-contents-link" href="#总结"><span class="section table-of-contents-text">总结</span></a></li></ol></li><li class="section table-of-contents-item section table-of-contents-level-4"><a class="section table-of-contents-link" href="#autorelease"><span class="section table-of-contents-text">__autorelease</span></a></li><li class="section table-of-contents-item section table-of-contents-level-4"><a class="section table-of-contents-link" href="#weak"><span class="section table-of-contents-text">__weak</span></a><ol class="section table-of-contents-child"><li class="section table-of-contents-item section table-of-contents-level-5"><a class="section table-of-contents-link" href="#使用-weak变量时"><span class="section table-of-contents-text">使用__weak变量时</span></a></li></ol></li></ol></li></ol></li><li class="section table-of-contents-item section table-of-contents-level-2"><a class="section table-of-contents-link" href="#Block的实现"><span class="section table-of-contents-text">Block的实现</span></a><ol class="section table-of-contents-child"><li class="section table-of-contents-item section table-of-contents-level-3"><a class="section table-of-contents-link" href="#不截获任何变量的Block"><span class="section table-of-contents-text">不截获任何变量的Block</span></a></li><li class="section table-of-contents-item section table-of-contents-level-3"><a class="section table-of-contents-link" href="#截获变量但不修改的Block"><span class="section table-of-contents-text">截获变量但不修改的Block</span></a></li><li class="section table-of-contents-item section table-of-contents-level-3"><a class="section table-of-contents-link" href="#截获-block变量"><span class="section table-of-contents-text">截获__block变量</span></a><ol class="section table-of-contents-child"><li class="section table-of-contents-item section table-of-contents-level-4"><a class="section table-of-contents-link" href="#全局变量"><span class="section table-of-contents-text">全局变量</span></a></li><li class="section table-of-contents-item section table-of-contents-level-4"><a class="section table-of-contents-link" href="#静态局部变量"><span class="section table-of-contents-text">静态局部变量</span></a></li><li class="section table-of-contents-item section table-of-contents-level-4"><a class="section table-of-contents-link" href="#局部变量"><span class="section table-of-contents-text">局部变量</span></a></li><li class="section table-of-contents-item section table-of-contents-level-4"><a class="section table-of-contents-link" href="#其他"><span class="section table-of-contents-text">其他</span></a></li></ol></li></ol></li><li class="section table-of-contents-item section table-of-contents-level-2"><a class="section table-of-contents-link" href="#GCD-与-runloop"><span class="section table-of-contents-text">GCD 与 runloop</span></a><ol class="section table-of-contents-child"><li class="section table-of-contents-item section table-of-contents-level-3"><a class="section table-of-contents-link" href="#runloop"><span class="section table-of-contents-text">runloop</span></a><ol class="section table-of-contents-child"><li class="section table-of-contents-item section table-of-contents-level-4"><a class="section table-of-contents-link" href="#主线程与runloop"><span class="section table-of-contents-text">主线程与runloop</span></a><ol class="section table-of-contents-child"><li class="section table-of-contents-item section table-of-contents-level-5"><a class="section table-of-contents-link" href="#硬件事件响应"><span class="section table-of-contents-text">硬件事件响应</span></a></li><li class="section table-of-contents-item section table-of-contents-level-5"><a class="section table-of-contents-link" href="#手势识别"><span class="section table-of-contents-text">手势识别</span></a></li><li class="section table-of-contents-item section table-of-contents-level-5"><a class="section table-of-contents-link" href="#界面更新"><span class="section table-of-contents-text">界面更新</span></a></li></ol></li></ol></li></ol></li><li class="section table-of-contents-item section table-of-contents-level-2"><a class="section table-of-contents-link" href="#参考"><span class="section table-of-contents-text">参考</span></a></li></ol>
</div>


            <div class="entry teal-link-context">
                <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>最近又看了一遍 <strong>Objective-C高级编程 iOS与OS X多线程和内存管理</strong> 这本书。对一些问题有了一些新的认识。这篇文章将讲讲下面几个话题：</p>
<ol>
<li><strong>ARC，MRC 与 引用计数</strong></li>
<li><strong>Block的实现</strong></li>
<li><strong>GCD与runloop</strong></li>
</ol>
<a id="more"></a>
<h2 id="ARC-MRC-与-引用计数"><a href="#ARC-MRC-与-引用计数" class="headerlink" title="ARC, MRC 与 引用计数"></a>ARC, MRC 与 引用计数</h2><h3 id="引用计数"><a href="#引用计数" class="headerlink" title="引用计数"></a>引用计数</h3><p>Objective C的生成的数据会存放在栈或者堆上面。对于存放在栈上面的数据（比如局部int变量等）在不需要时，系统会自动释放内存空间；对于存放在堆上面的数据（比如对象等）会使用引用计数来决定是否释放内存空间。</p>
<p>创建一个对象时，会malloc一块对象所需大小的内存空间；当有一变量持有该对象时（一般是有一指针指向该内存时）该对象的引用计数加一；当持有该对象的变量不再持有它时（一般是指针被销毁，或指向其他地方）该对象的引用计数减一。<strong>当对象的引用计数为0时，free这一块内存</strong></p>
<p><strong>MRC和ARC实质上都是对这个引用计数进行操作</strong></p>
<h3 id="手动引用计数-MRC"><a href="#手动引用计数-MRC" class="headerlink" title="手动引用计数 MRC"></a>手动引用计数 MRC</h3><p>手动引用计数要确保<strong>在对象从被创建到销毁的一生中，该对象的引用计数也从1变成0</strong>。</p>
<p>与对象引用计数相关的函数只有3个：</p>
<ol>
<li>alloc/new/copy/mutableCopy</li>
<li>retain</li>
<li>release</li>
</ol>
<h4 id="alloc-new-copy-mutableCopy"><a href="#alloc-new-copy-mutableCopy" class="headerlink" title="alloc/new/copy/mutableCopy"></a>alloc/new/copy/mutableCopy</h4><p>这几个函数生成一个对象，并且该对象的引用计数为1</p>
<h4 id="retain"><a href="#retain" class="headerlink" title="retain"></a>retain</h4><p><code>retain</code>函数将对象的引用计数加1</p>
<h4 id="release"><a href="#release" class="headerlink" title="release"></a>release</h4><p><code>release</code>函数将对象的引用计数减一</p>
<h4 id="examples"><a href="#examples" class="headerlink" title="examples"></a>examples</h4><h5 id="autorelease函数"><a href="#autorelease函数" class="headerlink" title="autorelease函数"></a>autorelease函数</h5><pre><code class="objective-c">NSAutoreleasePool *pool = [[NSAutoreleasePool alloc] init]  // 1
id obj = [[NSObject alloc] init];                           // 2
[obj autorelease];                                          // 3
[id dosomething];                                           // 4
[pool drain];                                               // 5
</code></pre>
<ol>
<li>注释2处，使用<code>alloc</code>方法新建一个对象，该对象的引用计数为1</li>
<li>注释3处，调用了<code>autorelease</code>函数；该函数并没有更改对象的引用计数，但是它将对象注册到自动释放池中</li>
<li>注释4处，因为注释3没有减少引用计数，所以对象的引用计数还是1。所以这个地方对象依然存在，可以正常使用对象</li>
<li>注释5处，因为在注释3时将对象注册进pool。此时<code>[pool drain]</code>方法会去调用对象的<code>release</code>方法，将对象引用计数减1；此时引用计数为0，那么释放内存空间</li>
</ol>
<p>所以从上面看出：<strong><code>autorelease</code>函数并没有改变对象的引用计数，只是简单的将对象与释放池挂钩；当<code>pool drain</code>时才调用对象的<code>release</code>函数</strong>。</p>
<p>所以 <strong><code>autorelease</code>函数实质就是延迟对象的<code>release</code>方法；可以让你放心使用对象，但又防止了你忘记释放对象</strong></p>
<h5 id="array类对象"><a href="#array类对象" class="headerlink" title="array类对象"></a>array类对象</h5><pre><code class="objective-c">id obj = [NSMutableArray array];
</code></pre>
<p>这里不需要调用对象的<code>release</code>方法。因为在内部的实现是：</p>
<pre><code class="objective-c">+ (id)array {
      id obj = [[NSMutableArray alloc] init];
      [obj autorelease];
      return obj;
}
</code></pre>
<p><code>array</code>类方法返回的对象，该对象的引用计数为1；但是已经注册到自动释放池中了，会在释放池结束时调用<code>release</code>方法</p>
<h4 id="MRC总结"><a href="#MRC总结" class="headerlink" title="MRC总结"></a>MRC总结</h4><p>对象一定成对的存在 <code>alloc</code> 和  <code>release</code>方法；或者成对的存在<code>retain</code> 和  <code>release</code> 方法。只有这样才能对引用计数有增有减，才能保证对象能正确的释放。</p>
<p>如果没有成对的出现，但是程序又是正确的，那么这3个方法的调用肯定在某函数的内部。比如<code>[pool drain]</code> 或者 <code>[NSMutableArray array]</code> 等函数中。</p>
<h3 id="自动引用计数-ARC"><a href="#自动引用计数-ARC" class="headerlink" title="自动引用计数 ARC"></a>自动引用计数 ARC</h3><p>ARC不再需要你来手动调用<code>retain</code> 和 <code>release</code> 函数了，系统会自己调用这些函数。那么ARC需要注意的是什么呢：</p>
<ol>
<li><strong>__strong</strong></li>
<li><strong>__weak</strong></li>
<li><strong>__autorelease</strong></li>
</ol>
<p>使用以上三个修饰符对对象进行修饰，那么就会自动增减引用计数</p>
<h4 id="strong"><a href="#strong" class="headerlink" title="__strong"></a>__strong</h4><p><strong>会自动release</strong></p>
<pre><code class="objective-c">{
      id obj = [[NSObject alloc] init];
}

// 转化之后

id obj = objc_msgSend(NSObject, @selector(alloc));
objc_msgSend(obj, @selector(init));
objc_release(obj);

/*--------------------------分割符------------------*/
{
      id __strong obj = obj2;
    // do something
}

// 转化之后

id obj = obj2;
[obj retain];
// do something
[obj release];
</code></pre>
<p>可以看到<code>__strong</code>会持有对象，并自动调用release将引用计数减一</p>
<p><strong>会阻止对象注册到release pool中，并持有对象</strong></p>
<pre><code class="objective-c">{
   id __strong obj = [NSMutableArray array];
}

// 转化之后

id obj = objc_msgSend(NSMutableArray, @selector(alloc));
objc_msgSend(obj, @selector(init));
return objc_autoreleaseReturnValue(obj);  

objc_retainAutoreleasedReturnValue(obj);
objc_release(obj);
</code></pre>
<p>可以看到，__strong会将即将注册到pool的对象抢过来，自己持有，并释放。</p>
<h5 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h5><p><code>__strong</code>修饰符会持有对象，并自动释放。有时会抢过pool的对象，来自己释放</p>
<h4 id="autorelease"><a href="#autorelease" class="headerlink" title="__autorelease"></a>__autorelease</h4><p>不常用，基本原理：</p>
<ol>
<li>对于已经/或即将注册到pool的对象，没有变化。会由pool来释放该对象</li>
<li>对于其他对象，会将对象retain，并强制注册到pool，由pool来release</li>
</ol>
<h4 id="weak"><a href="#weak" class="headerlink" title="__weak"></a>__weak</h4><p>weak变量不对引用计数产生影响。来看一下代码：</p>
<pre><code class="objective-c">id __weak obj1 = obj;
id __weak obj2 = obj;
</code></pre>
<p>APP管理一个全局的weak表，上面这两行代码，会往该表中插入2行记录：</p>
<p>每行记录的key是对象的首地址，也就是 <code>obj</code> ；value是存放weak变量的地址，也就是<code>&amp;obj1</code> 和 <code>&amp;obj2</code> 。</p>
<ol>
<li>当weak变量obj1被废弃时，将weak表中的value为<code>&amp;obj1</code>的记录删除</li>
<li>当对象被废弃时，这时候obj1,obj2应该指向nil。这时就将weak表中，key为<code>obj</code>的记录的key置成nil</li>
</ol>
<p><strong>所以寻找weak变量对应的对象地址时，其实就是寻找weak表中的key值</strong></p>
<h5 id="使用-weak变量时"><a href="#使用-weak变量时" class="headerlink" title="使用__weak变量时"></a>使用__weak变量时</h5><pre><code class="objective-c">{
      id __weak o = obj;
      NSLog(@&quot;%@&quot;, o);
}

// 转化之后

id o;
objc_initWeak(&amp;o, obj);
id tmp = objc_loadWeakRetained(&amp;o);
objc_autorelease(tmp);
NSLog(@&quot;%@&quot;, tmp);
objc_destoryWeak(&amp;o);
</code></pre>
<p>可以看到使用weak变量时，其实是将该weak变量指向的对象交由一个tmp变量持有，并将该对象注册到pool中。这样可以保证对象万一被释放了，也至少还有tmp持有他，可以正常使用。</p>
<h2 id="Block的实现"><a href="#Block的实现" class="headerlink" title="Block的实现"></a>Block的实现</h2><p><strong>使用clang的<code>-rewrite-objc</code>选项，可以将OC代码转换成C++代码。这样就可以看到Block的C++的实现</strong></p>
<h3 id="不截获任何变量的Block"><a href="#不截获任何变量的Block" class="headerlink" title="不截获任何变量的Block"></a>不截获任何变量的Block</h3><pre><code class="objective-c">int main() {
  void (^blk)(void) = ^{printf(&quot;Block\n&quot;);};
  blk();
  return 0;
}
</code></pre>
<p>经过 <code>clang -rewrite-objc main.m</code> 转化之后，生成<code>main.cpp</code> 。来看看Block在C++中如何表现：</p>
<pre><code class="c">// 只截取关键代码
struct __main_block_impl_0 {
  void *isa;
  int Flags;
  int Reserved;
  void *FuncPtr;
  struct __main_block_desc_0 *Desc;

  __main_block_impl_0(void *fp) {
    isa = &amp;_NSConcreteStackBlock;
    FuncPtr = fp;
  }
};

static void __main_block_func_0(struct __main_block_impl_0 *__cself) {
  printf(&quot;Block\n&quot;);
};

int main() {
  struct __main_block_impl_0 tmp = __main_block_impl_0(__main_block_func_0);
  struct __main_block_impl_0 *blk = &amp;tmp;
  (*blk-&gt;FuncPtr)(blk);
  return 0;
}
</code></pre>
<p><strong>可以发现Block实际上是一个结构体，blk变量是指向<code>__main_block_impl_0</code>结构体的指针。该结构体中有一个函数指针 <code>FuncPtr</code>，执行Block时，其实就是执行该结构体中函数指针对应的函数。</strong></p>
<h3 id="截获变量但不修改的Block"><a href="#截获变量但不修改的Block" class="headerlink" title="截获变量但不修改的Block"></a>截获变量但不修改的Block</h3><pre><code class="objective-c">int main() {
  int val = 10;
  void (^blk)(void) = ^{printf(&quot;%d&quot;, val);};
  blk();
  return 0;
}
</code></pre>
<p>相同的方法，来看一下转化之后的结果：</p>
<pre><code class="c">struct __main_block_impl_0 {
  void *fp;
  int Flags;
  int Reserved;
  void *FuncPtr;
  struct __main_block_desc_0 *Desc;

  int val;

  __main_block_impl_0(void *fp, int _val) : val(_val) {
    isa = &amp;_NSConcreteStackBlock;
    FuncPtr = fp;
  }
};

static void __main_block_func_0(struct __main_block_impl_0 *__cself) {
  int val = __cself-&gt;val;
  printf(&quot;%d&quot;, val);
}

int main() {
  int val = 10;
  struct __main_block_impl_0 = __main_block_impl_0(__main_block_func_0, val);
  struct __main_block_impl_0 *blk = &amp;tmp;
  (*blk-&gt;FuncPtr)(blk);

  return 0;
}
</code></pre>
<p><strong>可以看到，对于截获但是未曾改变的变量<code>val</code>，Block结构体会将该变量拷贝到结构体中的同名成员变量中。所以当main函数里面定义的val之后无论如何改变，都不会影响到Block中存储的val变量；因为他们两个是不同的两个变量。</strong></p>
<h3 id="截获-block变量"><a href="#截获-block变量" class="headerlink" title="截获__block变量"></a>截获__block变量</h3><p>当要在Block里面改变截获的变量时，需要使用<strong>__block</strong>修饰符。</p>
<h4 id="全局变量"><a href="#全局变量" class="headerlink" title="全局变量"></a>全局变量</h4><pre><code class="c">int global_val = 2;
int main() {
  // do something
}
</code></pre>
<p>对于全局变量，Block可以直接访问，不需要做任何的改变</p>
<h4 id="静态局部变量"><a href="#静态局部变量" class="headerlink" title="静态局部变量"></a>静态局部变量</h4><pre><code class="objective-c">int main() {
  static int static_val = 3;
  void (^blk)(void) = ^{
    static_val += 1;
  }

  return 0;
}
</code></pre>
<p>来看转化之后：</p>
<pre><code class="c">struct __main_block_impl_0 {
  // 一些其他成员
  int *static_val;

  __main_block_impl_0(void *fp, int *_static_val) : static_val(_static_val) {
    isa = &amp;_NSConcreteStackBlock;
    FuncPrt = fp;
  }
};

static void __main_block_func_0(struct __main_block_impl_0 *__cself) {
  int *static_val = __cself-&gt;static_val;
  *static_val += 1;
}

int main() {
  static int static_val = 3;
  blk = &amp;__main_block_impl_0(__main_block_func_0, &amp;static_val);

  return 0;
}
</code></pre>
<p><strong>可以看到，对于静态局部变量，Block的结构体中存放的是指向该变量的指针，所以可以通过指针来改变该静态局部变量。这是因为，静态局部变量即使其作用域已经结束，但是它并不会被销毁，其内存空间是一直存在的</strong></p>
<h4 id="局部变量"><a href="#局部变量" class="headerlink" title="局部变量"></a>局部变量</h4><pre><code class="objective-c">int main() {
  __block int val = 10;
  void (^blk)(void) = ^{val = 1;};
  return 0;
}
</code></pre>
<p><strong>在Block中改变局部自动变量需要使用<code>__block</code>修饰符</strong>；转化成C++代码：</p>
<pre><code class="c">struct __Block_byref_val_0 {
  void *__isa;
  __Block_byref_val_0 *__forwarding;
  int __flags;
  int __size;
  int val;
};

struct __main_block_impl_0 {
  // 其他成员变量

  __Block_byref_val_0 *val;

  __main_block_impl_0(void *fp, __Block_byref_val_0 *_val) : val(_val-&gt;__forwarding) {
    //
  }
};

static void __main_block_func_0(struct __main_block_impl_0 *__cself) {
  __Block_byref_val_0 *val = __cself-&gt;val;
  (val-&gt;forwarding-&gt;val) = 1;
}

int main() {
  __Block_byref_val_0 val = {
    0,
    &amp;val,
    0,
    sizeof(__Block_byref_val_0),
    10
  };

  blk = &amp;__main_block_impl_0(__main_block_func_0, &amp;val);
  return 0;
}
</code></pre>
<p>可以看到_<em>block变量val其实是一个结构体 \</em>_Block_byref_val_0。在里面有val这个变量。</p>
<p>因为正常生成的Block都是在栈上面的，但是在合适的情况下面，栈上的Block会被拷贝到堆上；与此同时，Block所拥有的__block结构体也会被拷贝到堆上，相当于Block持有__block变量。</p>
<p>当block变量还在栈上时，它的forwarding指向自己；当被拷贝到堆上时，forwarding指向堆上的block变量。在使用时全部使用forwarding，这样可以保证改变的是同一个变量。</p>
<p><strong>使用这么一个结构体来存放局部变量，可以保证局部变量可以时时刻刻被更改，也可以保证栈上局部变量被释放后，堆上的局部变量依然可以访问</strong></p>
<h4 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h4><p>在堆上的Block或者block变量才谈论对象的retain以及release；在栈上的Block和block会被栈自动释放，也不存在对象的retain和release</p>
<p>Block会在一下情况下被复制到堆上面：</p>
<ol>
<li>显式调用Block的<code>copy</code>方法</li>
<li>Block作为函数返回值返回</li>
<li>将Block赋给<code>__strong</code>的id类型或者Block的类的成员变量时 （这时候要注意self和Block的循环引用）</li>
<li>方法名中含有usingBlock的Cocoa框架方法，或者GCD中使用的Block</li>
</ol>
<h2 id="GCD-与-runloop"><a href="#GCD-与-runloop" class="headerlink" title="GCD 与 runloop"></a>GCD 与 runloop</h2><ol>
<li>GCD操作的是<code>queue</code>，然后由queue来确定block该由哪个线程来执行。</li>
<li>runloop对应的则直接是线程。一个线程可以有0-1个runloop在上面执行。</li>
</ol>
<h3 id="runloop"><a href="#runloop" class="headerlink" title="runloop"></a>runloop</h3><p>runloop实际上就是一个运行在特定线程上面的do-while循环。在do-while循环里面，可以处理多种事件：</p>
<ol>
<li>port-based event，多半是系统事件</li>
<li>其他线程传递给当前线程来直线的block</li>
<li>Timer，定时事件</li>
<li>Observer，当runloop状态变化时，执行相应的监听器</li>
</ol>
<p>有事件来时，runloop就执行事件；没有事件，就进入休眠，但是并没有退出do-while循环。只有当runloop到达限定时间，或者手动退出runloop；这个do-while循环才会结束</p>
<h4 id="主线程与runloop"><a href="#主线程与runloop" class="headerlink" title="主线程与runloop"></a>主线程与runloop</h4><p>APP的主线程一直运行着一个runloop循环，这个runloop由系统运行，并且已经往该runloop中添加了一些事件。</p>
<h5 id="硬件事件响应"><a href="#硬件事件响应" class="headerlink" title="硬件事件响应"></a>硬件事件响应</h5><p>当发生硬件事件时，也就是触摸，锁屏，摇动等事件时；这些事件都是系统事件，也就是port-based的类型。那么runloop会使用<code>_UIApplicationHandleEventQueue()</code>该函数来处理这一类事件</p>
<h5 id="手势识别"><a href="#手势识别" class="headerlink" title="手势识别"></a>手势识别</h5><p>在<code>_UIApplicationHandleEventQueue()</code>函数中，会识别出需要待处理的手势。当runloop进入休眠之前，会出发Observer，在这个Observer中会调用<code>_UIGestureRecognizerUpdateObserver()</code>函数，该函数会处理手势（也就是这行手势的回调函数）</p>
<h5 id="界面更新"><a href="#界面更新" class="headerlink" title="界面更新"></a>界面更新</h5><p>每当runloop即将进入休眠，或者即将退出时，会执行一个Observer。在这个Observer里面会查看每个View的frame等属性，如果需要重新绘制，那么开始重新绘制的过程。（layout -&gt; display -&gt; draw 等等）</p>
<p><strong>所以当其他的事件执行时间过长，超过16ms的话，就会推迟进入休眠，也就会推迟Observer的触发，也就会推迟界面的更新。那么就会造成卡顿的现象。</strong></p>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><ul>
<li><a href="http://blog.ibireme.com/2015/05/18/runloop/" target="_blank" rel="external">深入理解RunLoop</a></li>
</ul>

                
<p class="teal-link-context">
    <a href="/2017/07/07/JSPatch-source-analyze/" rel="next" title="JSPatch源码分析">
    上一篇：JSPatch源码分析
  </a>
</p>



<p class="teal-link-context">
    <a href="/2017/06/10/objective-c-runtime-other/" rel="next" title="Objective-C runtime - 如果还有其他的话">
    下一篇：Objective-C runtime - 如果还有其他的话
  </a>
</p>


            </div>
			
        </div>
    </div>
</article>






</div>

        <div class="fixed-action-btn float-sitemap">
    <a class="btn-floating btn-large lime">
      <i class="fa fa-caret-square-o-up"></i>
    </a>
    <ul>
      <li><a class="btn-return-top btn-floating waves-effect lime darken-1" title="回到顶部"><i class="fa fa-arrow-circle-o-up"></i></a></li>
      <li><a class="btn-floating waves-effect button-collapse lime darken-2"  data-activates="main-menu" title="菜单"><i class="fa fa-navicon"></i></a></li>
    </ul>
  </div>

    </main>
    <footer class="page-footer blue-grey darken-1">
    
    <div class="footer-container container">
        <div class="row">
            
            <div class="social-group col m4 s12">
                <h5 class="white-text">社交</h5>
                
                    <a class="social-link" href="http://weibo.com/3911241332" target="_blank">
                        <i class="fa fa-2x fa-weibo"></i>
                    </a>
                
                    <a class="social-link" href="https://github.com/vanney9" target="_blank">
                        <i class="fa fa-2x fa-github"></i>
                    </a>
                
                    <a class="social-link" href="/atom.xml" target="_blank">
                        <i class="fa fa-2x fa-rss"></i>
                    </a>
                
                

            </div>
            

            
            <div class="col m8 s12">
                <h5 class="white-text">友情链接</h5>
                
                    <a class="social-link" href="http://raytaylorlin.com/" target="_blank">实验室前端大神，博客主题作者 寿寿</a>
                
                    <a class="social-link" href="http://tutuge.me/" target="_blank">实验室iOS大神 土哥</a>
                
            </div>
            
        </div>
    </div>
    

    <div class="footer-copyright teal-link-context">
        <div class="container">
            © 2017 vanney9.com, All rights reserved.
            <p class="right" style="margin-top: 0;">本博客由 <a href="https://hexo.io">Hexo</a> 强力驱动 | 主题 <a href="https://github.com/raytaylorlin/hexo-theme-raytaylorism">raytaylorism</a></p>
            <script src="https://s95.cnzz.com/z_stat.php?id=1257182745&web_id=1257182745" language="JavaScript"></script>
        </div>
    </div>
</footer>


    <noscript>
    <div class="noscript">
        <p class="center-align">当前网速较慢或者你使用的浏览器不支持博客特定功能，请尝试刷新或换用Chrome、Firefox等现代浏览器</p>
    </div>
</noscript>
<div class="noscript">
    <p class="center-align">当前网速较慢或者你使用的浏览器不支持博客特定功能，请尝试刷新或换用Chrome、Firefox等现代浏览器</p>
</div>


<script src="/js/jquery.min.js"></script>
<script src="/js/materialize.min.js"></script>

<script>
    (function($) {
        $(document).ready(function() {
            // 隐藏禁用javascript（针对微信内置浏览器）的提示
            $('.noscript').hide();

            // 图片缩放效果
            var $imgs = $('img').not('.slider-image').not('.avatar-image').not('.carousel-image').not('.card-cover-image').not('.qrcode');

            // 给图片加上点击放大效果（materialbox插件）
            $imgs.addClass('materialboxed').each(function(i, el) {
                $(this).attr('data-caption', $(this).attr('alt') || ' ');
            }).materialbox();

            // 优化表格的显示
            $('table').each(function() {
                var $table = $(this);
                // 除去多行代码的情况
                if ($table.find('pre').length == 0) {
                    $table.addClass('responsive-table striped bordered');
                }
            });

            // 首页幻灯片
            $('.slider').slider({indicators: true, full_width: true, interval: 8000});

            $(".button-collapse").sideNav();
            $(".category-menu").sideNav();

            // 针对gallery post
            $('.carousel').carousel({full_width: true});
            $('.carousel-control.prev').click(function() {
                $('.carousel').carousel('prev');
            });
            $('.carousel-control.next').click(function() {
                $('.carousel').carousel('next');
            });

            // 文章目录
            $('article').not('.simple-article').find('h1').add('h2').add('h3').add('h4').add('h5').add('h6').scrollSpy();

            // 目录随屏幕滚动（防止目录过长越过footer）
            var $toc = $('.toc');
            var scrollTargetTop = 0;
            $(window).scroll(function() {
                var $activeLink = $toc.find('a.active.section');
                if ($(window).scrollTop() < 100) {
                    scrollTargetTop = 0;
                } else {
                    if ($activeLink[0]) {
                        scrollTargetTop = $activeLink.offset().top - $toc.offset().top;
                    }
                }
                $toc.css('top', '-' + scrollTargetTop + 'px');
            });

            // 修正文章目录的left-border颜色
            var color = $('.table-of-contents-text').css('color');
            $('.table-of-contents-link').css('border-left-color', color);

            // 针对移动端做的优化：FAB按钮点击一下收回
            if (/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)) {
                $('.fixed-action-btn').addClass('click-to-toggle');
            }
            // 回到顶部
            $('.btn-return-top').click(function() {
                $('body, html').animate({
                    scrollTop: 0
                }, 500);
            });

            // 重置读书页面的Tab标签页的颜色
            $('li.tab a').hover(function() {
                $(this).toggleClass('text-lighten-4');
            });
            $('.indicator').addClass('teal accent-1 lighten-2');

            
            // 添加new标签
            $('.menu-about').append('<span class="new badge lime lighten-1"></span>');
            

            // 搜索功能
            $('.modal-trigger').leanModal({
                // 打开搜索框时自动聚焦
                ready: function() {
                    if ($('#search').is(":visible")) {
                        $('#search-input').focus();
                    }
                }
            });
            var searchXml = "search.xml";
            if (searchXml.length == 0) {
             	searchXml = "search.xml";
            }
            var searchPath = "/" + searchXml;
            initSearch(searchPath, 'search-input', 'search-result');
        });

        // 初始化搜索与匹配函数
        var initSearch = function(path, search_id, content_id) {
            'use strict';
            $.ajax({
                url: path,
                dataType: "xml",
                success: function(xmlResponse) {
                    // get the contents from search data
                    var datas = $("entry", xmlResponse).map(function() {
                        return {
                            title: $("title", this).text(),
                            content: $("content", this).text(),
                            url: $("url", this).text()
                        };
                    }).get();
                    var $input = document.getElementById(search_id);
                    var $resultContent = document.getElementById(content_id);
                    $input.addEventListener('input', function() {
                        var str = '<ul class=\"search-result-list\">';
                        var keywords = this.value.trim().toLowerCase().split(/[\s\-]+/);
                        $resultContent.innerHTML = "";
                        if (this.value.trim().length <= 0) {
                            return;
                        }
                        // perform local searching
                        datas.forEach(function(data) {
                            var isMatch = true;
                            var content_index = [];
                            var data_title = data.title.trim().toLowerCase();
                            var data_content = data.content.trim().replace(/<[^>]+>/g, "").toLowerCase();
                            var data_url = data.url;
                            var index_title = -1;
                            var index_content = -1;
                            var first_occur = -1;
                            // only match artiles with not empty titles and contents
                            if (data_title != '' && data_content != '') {
                                keywords.forEach(function(keyword, i) {
                                    index_title = data_title.indexOf(keyword);
                                    index_content = data_content.indexOf(keyword);
                                    if (index_title < 0 && index_content < 0) {
                                        isMatch = false;
                                    } else {
                                        if (index_content < 0) {
                                            index_content = 0;
                                        }
                                        if (i == 0) {
                                            first_occur = index_content;
                                        }
                                    }
                                });
                            }
                            // show search results
                            if (isMatch) {
                                keywords.forEach(function(keyword) {
                                    var regS = new RegExp(keyword, "gi");
                                    data_title = data_title.replace(regS, "<span class=\"search-keyword teal lighten-2\">" + keyword + "</span>");
                                });

                                str += "<li><a href='" + data_url + "' class='search-result-title'>" + data_title + "</a>";
                                var content = data.content.trim().replace(/<[^>]+>/g, "");
                                if (first_occur >= 0) {
                                    // cut out 100 characters
                                    var start = first_occur - 20;
                                    var end = first_occur + 80;
                                    if (start < 0) {
                                        start = 0;
                                    }
                                    if (start == 0) {
                                        end = 100;
                                    }
                                    if (end > content.length) {
                                        end = content.length;
                                    }
                                    var match_content = content.substring(start, end);
                                    // highlight all keywords
                                    keywords.forEach(function(keyword) {
                                        var regS = new RegExp(keyword, "gi");
                                        match_content = match_content.replace(regS, "<span class=\"search-keyword teal lighten-2\">" + keyword + "</span>");
                                    });

                                    str += "<p class=\"search-result\">..." + match_content + "...</p>"
                                }
                                str += "</li>";
                            }
                        });
                        str += "</ul>";
                        $resultContent.innerHTML = str;
                    });
                }
            });
        }
    })(jQuery);
</script>


<script src="/js/google/prettify.js"></script>
<script type="text/javascript">
    $(document).ready(function() {
        $("pre").addClass("prettyprint");
        prettyPrint();
    });
</script>








</body>
</html>
