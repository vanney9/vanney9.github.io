<!doctype html>



  


<html class="theme-next mist use-motion">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />












  
  
  <link href="/vendors/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/vendors/font-awesome/css/font-awesome.min.css?v=4.4.0" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.0.1" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="iOS,runtime," />








  <link rel="shortcut icon" type="image/x-icon" href="/lion3.ico?v=5.0.1" />






<meta name="description" content="前言系列第五篇：将展示几个runtime的例子以及runtime的实际应用。这些例子包括：

动态添加属性以及添加用来存储属性对应的实例变量的关联对象
方法决议：父类实resolveInstanceMethod，然后在子类中添加方法
消息转发示例：
forwardingTargetForSelector
forwardInvocation



本文的demo代码可以在我的github上找到">
<meta property="og:type" content="article">
<meta property="og:title" content="Objective-C runtime - 应用和示例">
<meta property="og:url" content="http://yoursite.com/2017/06/10/objective-c-runtime-example/index.html">
<meta property="og:site_name" content="Vanney">
<meta property="og:description" content="前言系列第五篇：将展示几个runtime的例子以及runtime的实际应用。这些例子包括：

动态添加属性以及添加用来存储属性对应的实例变量的关联对象
方法决议：父类实resolveInstanceMethod，然后在子类中添加方法
消息转发示例：
forwardingTargetForSelector
forwardInvocation



本文的demo代码可以在我的github上找到">
<meta property="og:image" content="http://yoursite.com/lionheart/1706/resolve.png">
<meta property="og:image" content="http://yoursite.com/lionheart/1706/forwarding1.png">
<meta property="og:image" content="http://yoursite.com/lionheart/1706/forwarding2.png">
<meta property="og:updated_time" content="2017-06-10T09:18:24.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Objective-C runtime - 应用和示例">
<meta name="twitter:description" content="前言系列第五篇：将展示几个runtime的例子以及runtime的实际应用。这些例子包括：

动态添加属性以及添加用来存储属性对应的实例变量的关联对象
方法决议：父类实resolveInstanceMethod，然后在子类中添加方法
消息转发示例：
forwardingTargetForSelector
forwardInvocation



本文的demo代码可以在我的github上找到">
<meta name="twitter:image" content="http://yoursite.com/lionheart/1706/resolve.png">



<script type="text/javascript" id="hexo.configuration">
  var NexT = window.NexT || {};
  var CONFIG = {
    scheme: 'Mist',
    sidebar: {"position":"left","display":"post"},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: 0,
      author: '博主'
    }
  };
</script>




  <link rel="canonical" href="http://yoursite.com/2017/06/10/objective-c-runtime-example/"/>

  <title> Objective-C runtime - 应用和示例 | Vanney </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  








  <div style="display:none">
    <script src="http://s95.cnzz.com/z_stat.php?id=1257182745&web_id=1257182745" language="JavaScript"></script>
  </div>





  
  
    
  

  <div class="container one-collumn sidebar-position-left page-post-detail ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-meta ">
  

  <div class="custom-logo-site-title">
    <a href="/"  class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <span class="site-title">Vanney</span>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>
  <p class="site-subtitle"></p>
</div>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      

      
    </ul>
  

  
</nav>

 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                Objective-C runtime - 应用和示例
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2017-06-10T14:31:59+08:00" content="2017-06-10">
              2017-06-10
            </time>
          </span>

          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2017/06/10/objective-c-runtime-example/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2017/06/10/objective-c-runtime-example/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>系列第五篇：将展示几个runtime的例子以及runtime的实际应用。这些例子包括：</p>
<ol>
<li>动态<strong>添加属性</strong>以及添加用来存储属性对应的实例变量的<strong>关联对象</strong></li>
<li>方法决议：父类实<code>resolveInstanceMethod</code>，然后在子类中添加方法</li>
<li>消息转发示例：<ol>
<li><code>forwardingTargetForSelector</code></li>
<li><code>forwardInvocation</code></li>
</ol>
</li>
</ol>
<p>本文的demo代码可以在<a href="https://github.com/vanney9/runtime" target="_blank" rel="external">我的github</a>上找到</p>
<a id="more"></a>
<h2 id="几个有趣的示例"><a href="#几个有趣的示例" class="headerlink" title="几个有趣的示例"></a>几个有趣的示例</h2><h3 id="动态添加任意属性"><a href="#动态添加任意属性" class="headerlink" title="动态添加任意属性"></a>动态添加任意属性</h3><blockquote>
<p><code>class_addProperty</code> runtime添加属性API</p>
<p><code>class_addMethod</code> runtime添加方法API</p>
</blockquote>
<p>仅仅添加属性是没什么用的，因为还需要添加属性对应的实例变量。</p>
<p><strong>虽然runtime提供了<code>class_addIvar</code>方法来给类添加实例变量，但是注意，该方法只能在创建新的类的时候才能使用；对于已经存在的类，是不允许添加实例变量的</strong></p>
<p>鉴于上述原因，所以可以采用动态添加关联对象来存储属性对应的实例变量。</p>
<h4 id="添加属性"><a href="#添加属性" class="headerlink" title="添加属性"></a>添加属性</h4><p><code>BOOL class_addProperty(Class cls, const char *name, const objc_property_attribute_t *attributes, unsigned int attributeCount)</code></p>
<ol>
<li><code>cls</code> : 要添加属性的类</li>
<li><code>name</code> : 添加属性的名字</li>
<li><code>attributes</code> : 属性的特性</li>
<li><code>attributeCount</code> : 属性特性数量</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">// runtime add property</div><div class="line">objc_property_attribute_t attribute1 = &#123;&quot;T&quot;, @encode(NSString *)&#125;;</div><div class="line">objc_property_attribute_t attribute2 = &#123;&quot;N&quot;, &quot;&quot;&#125;;</div><div class="line">objc_property_attribute_t attribute3 = &#123;&quot;&amp;&quot;, &quot;&quot;&#125;;</div><div class="line">objc_property_attribute_t attribute[] = &#123;attribute1, attribute2, attribute3&#125;;</div><div class="line">class_addProperty([HCBase class], &quot;sb&quot;, attribute, 3);</div></pre></td></tr></table></figure>
<p>如上代码，添加了一个属性<code>sb</code>，该属性有3个特性：1. NSString类型 2. nonatomic 3. strong</p>
<h4 id="添加关联对象"><a href="#添加关联对象" class="headerlink" title="添加关联对象"></a>添加关联对象</h4><p>为了向正常属性那样访问，给该类添加<code>sb</code>属性的存取方法<code>sb</code> 和 <code>setSb:</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">// add property getter and setter</div><div class="line">//class_addMethod([HCBase class], @selector(sb), (IMP) sb, &quot;@@:&quot;);</div><div class="line">class_addMethod([HCBase class], NSSelectorFromString(@&quot;sb&quot;), (IMP) customGetter, &quot;@@:&quot;);</div><div class="line">//class_addMethod([HCBase class], @selector(setSb:), (IMP) setSb, &quot;v@:@&quot;);</div><div class="line">class_addMethod([HCBase class], NSSelectorFromString(@&quot;setSb:&quot;), (IMP) customSetter, &quot;v@:@&quot;);</div></pre></td></tr></table></figure>
<p>注意该方法的最后一个参数是添加的方法的签名：<code>返回类型 + self + selector + 参数</code> 的字符串：</p>
<ol>
<li><code>sb</code>方法，返回类型为id(<strong>@</strong>)，self为id(<strong>@</strong>)，选择子(<strong>:</strong>)，参数为空 =&gt; @@:</li>
<li><code>setSb:</code>方法，返回类型为void(<strong>v</strong>)，self为id(<strong>@</strong>)，选择子(<strong>:</strong>)，参数为id(<strong>@</strong>) =&gt;  v@:@</li>
</ol>
<p>现在来看看setter和getter的通用实现方法</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">// custom getter &amp;&amp; setter</div><div class="line"></div><div class="line">void customSetter(id self, SEL _cmd, id value) &#123;</div><div class="line">    NSString *propertyStr = NSStringFromSelector(_cmd);</div><div class="line">    // divide set</div><div class="line">    NSString *realProperty = [propertyStr substringFromIndex:3];</div><div class="line">    realProperty = [realProperty substringToIndex:realProperty.length - 1];</div><div class="line">    realProperty = [realProperty lowercaseString];</div><div class="line">    //const NSString *key = [realProperty copy];</div><div class="line">    objc_setAssociatedObject(self, NSSelectorFromString(realProperty), value, OBJC_ASSOCIATION_RETAIN_NONATOMIC);</div><div class="line">    //objc_setAssociatedObject(self, &quot;sb&quot;, value, OBJC_ASSOCIATION_RETAIN_NONATOMIC);</div><div class="line">&#125;</div><div class="line"></div><div class="line">id customGetter(id self, SEL _cmd) &#123;</div><div class="line">    id result = objc_getAssociatedObject(self, _cmd);</div><div class="line">    //id result = objc_getAssociatedObject(self, &quot;sb&quot;);</div><div class="line">    return result;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>这两个方法通过判断selector来判断要添加的是哪一个属性的关联对象，也就是说这个方法是对任何属性通用的（之后新添加其他的属性，也可以使用该实现）</p>
<p>注意：<code>objc_setAssociationObject</code> 和 <code>objc_getAssociationObject</code>方法中的第二个参数，也就是对象的key是一个 <code>const void *</code> 类型：常量指针；正好@selector也是常量指针。</p>
<h4 id="访问属性"><a href="#访问属性" class="headerlink" title="访问属性"></a>访问属性</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">// new HCBase and set &amp;&amp; printf sb</div><div class="line">HCBase *baseOBJ = [[HCBase alloc] init];</div><div class="line">//[baseOBJ performSelector:@selector(setSb:) withObject:@&quot;sb&quot;];</div><div class="line">[baseOBJ performSelector:NSSelectorFromString(@&quot;setSb:&quot;) withObject:@&quot;sb&quot;];</div><div class="line">//NSLog(@&quot;vanney code log : new property is %@&quot;, [baseOBJ performSelector:@selector(sb)]);</div><div class="line">NSLog(@&quot;vanney code log : new property is %@&quot;, [baseOBJ performSelector:NSSelectorFromString(@&quot;sb&quot;)]);</div></pre></td></tr></table></figure>
<p>已经添加了属性，并添加了存取方法。现在可以使用<code>performSelector</code>方法来执行存取方法</p>
<h3 id="方法决议"><a href="#方法决议" class="headerlink" title="方法决议"></a>方法决议</h3><blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">&gt; + (BOOL)resolveInstanceMethod:(SEL)sel;</div><div class="line">&gt;</div></pre></td></tr></table></figure>
</blockquote>
<p>当没有找到方法的实现时，会执行该方法，可以在该方法里面动态添加缺失的方法的实现。</p>
<p>来看看两个类的声明：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line">/*--------- HCBase -----------*/</div><div class="line">#import &quot;runtime.h&quot;</div><div class="line">#import &lt;Foundation/Foundation.h&gt;</div><div class="line"></div><div class="line">@interface HCBase : NSObject</div><div class="line"></div><div class="line">//@property (nonatomic, strong) NSString *curry;</div><div class="line">//@property (nonatomic, copy) NSString *kd;</div><div class="line">//@property (nonatomic, assign) int kt;</div><div class="line"></div><div class="line">- (void)needResolve;</div><div class="line"></div><div class="line">- (void)needForwardTarget;</div><div class="line"></div><div class="line">- (void)needFinalForward;</div><div class="line"></div><div class="line">@end</div><div class="line"></div><div class="line">/*----------- HCSon -----------*/</div><div class="line">#import &quot;HCBase.h&quot;</div><div class="line"></div><div class="line">@interface HCSon : HCBase</div><div class="line"></div><div class="line">@end</div></pre></td></tr></table></figure>
<p><code>HCSon</code> 继承自 <code>HCBase</code> 类，另外<code>HCBase</code>中声明了一个方法<code>needResolve</code>，但是没有提供实现。</p>
<p>那么当一个<code>HCSon</code>对象调用<code>needResolve</code>方法时，无法找到实现；接着会去寻找<code>resolveInstanceMethod:</code>，并执行该方法。但是该<code>resolveInstanceMethod</code>方法定义在父类<code>HCBase</code>里面</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">void resolveImp(id self, SEL _cmd) &#123;</div><div class="line">    NSLog(@&quot;vanney code log : resolved function&quot;);</div><div class="line">&#125;</div><div class="line"></div><div class="line">@implementation HCBase</div><div class="line">+ (BOOL)resolveInstanceMethod:(SEL)sel &#123;</div><div class="line">    if ([NSStringFromSelector(sel) isEqualToString:@&quot;needResolve&quot;]) &#123;</div><div class="line">        class_addMethod(self, @selector(needResolve), (IMP) resolveImp, &quot;v@:&quot;);</div><div class="line">        return YES;</div><div class="line">    &#125; else &#123;</div><div class="line">        return [[self superclass] resolveInstanceMethod:sel];</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line">@end</div></pre></td></tr></table></figure>
<p>该方法给self类添加一个<code>needResolve</code>方法，之后会重新执行<code>needResolve</code>方法。</p>
<p>现在来看看一个HCSon对象调用<code>needResolve</code>的过程</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line">// resolve</div><div class="line"></div><div class="line">// print method</div><div class="line">int methodCount;</div><div class="line">Method *methodList = class_copyMethodList([HCBase class], &amp;methodCount);</div><div class="line">for (int j = 0; j &lt; methodCount; ++j) &#123;</div><div class="line">Method curMethod = methodList[j];</div><div class="line">printf(&quot;before HCBase method name is %s, and type encoding is %s\n&quot;, method_getName(curMethod), method_getTypeEncoding(curMethod));</div><div class="line">&#125;</div><div class="line"></div><div class="line">int methodCountS;</div><div class="line">Method *methodListS = class_copyMethodList([HCSon class], &amp;methodCountS);</div><div class="line">for (int j = 0; j &lt; methodCountS; ++j) &#123;</div><div class="line">Method curMethod = methodListS[j];</div><div class="line">printf(&quot;before HCSon method name is %s, and type encoding is %s\n&quot;, method_getName(curMethod), method_getTypeEncoding(curMethod));</div><div class="line">&#125;</div><div class="line"></div><div class="line">HCSon *son = [[HCSon alloc] init];</div><div class="line">//[baseOBJ needResolve];</div><div class="line">[son needResolve];</div><div class="line"></div><div class="line">Method *newMethodList = class_copyMethodList([HCBase class], &amp;methodCount);</div><div class="line">for (int j = 0; j &lt; methodCount; ++j) &#123;</div><div class="line">Method curMethod = newMethodList[j];</div><div class="line">printf(&quot;new HCBase method name is %s, and type encoding is %s\n&quot;, method_getName(curMethod), method_getTypeEncoding(curMethod));</div><div class="line">&#125;</div><div class="line"></div><div class="line">Method *newMethodListS = class_copyMethodList([HCSon class], &amp;methodCountS);</div><div class="line">for (int j = 0; j &lt; methodCountS; ++j) &#123;</div><div class="line">Method curMethod = newMethodListS[j];</div><div class="line">printf(&quot;new HCSon method name is %s, and type encoding is %s\n&quot;, method_getName(curMethod), method_getTypeEncoding(curMethod));</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>在执行<code>[son needResolve]</code>之前，先打印父类和子类的方法，可以发现都没有<code>needResolve</code>方法；执行之后再次打印，发现<code>HCSon</code>里面增加了<code>needResolve</code>方法。</p>
<p><strong>因为执行<code>resolveInstanceMethod</code>方法时，传入的<code>self</code>是<code>HCSon</code>，所以方法就添加在<code>HCSon</code>里面</strong></p>
<p><img src="/lionheart/1706/resolve.png" alt="resolve"></p>
<p><strong>注意图片的最后一行</strong></p>
<h3 id="消息转发"><a href="#消息转发" class="headerlink" title="消息转发"></a>消息转发</h3><h4 id="备援对象"><a href="#备援对象" class="headerlink" title="备援对象"></a>备援对象</h4><blockquote>
<p><code>- (id)forwardingTargetForSelector:(SEL)selector;</code></p>
</blockquote>
<p><code>HCBase</code>声明了<code>needForwardTarget</code>方法，但是没有实现；但是<code>HCBeitai</code>类有该方法。可以使用<code>forwardingTargetForSelector</code>方法，返回一个<code>HCBeitai</code>对象，让该对象来执行<code>needForwardTarget</code>方法。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line">/*------------ HCBeiTai -----------*/</div><div class="line">#import &lt;Foundation/Foundation.h&gt;</div><div class="line"></div><div class="line">@interface HCBeiTai : NSObject</div><div class="line"></div><div class="line">- (void)needForwardTarget;</div><div class="line"></div><div class="line">- (void)beitaiForwarding:(int)index;</div><div class="line"></div><div class="line">@end</div><div class="line"></div><div class="line">@implementation HCBeiTai</div><div class="line"></div><div class="line">- (void)needForwardTarget &#123;</div><div class="line">    NSLog(@&quot;bei tai 作用了&quot;);</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (void)beitaiForwarding:(int)index &#123;</div><div class="line">    NSLog(@&quot;vanney code log : bei tai 终极forwarding起作用了 : index is %d&quot;, index);</div><div class="line">&#125;</div><div class="line"></div><div class="line">@end</div><div class="line">  </div><div class="line">/*-------------- HCBase ------------*/</div><div class="line">- (id)forwardingTargetForSelector:(SEL)aSelector &#123;</div><div class="line">    if (aSelector == @selector(needForwardTarget)) &#123;</div><div class="line">        NSLog(@&quot;vanney code log : forwarding Target start&quot;);</div><div class="line">        HCBeiTai *beitai = [[HCBeiTai alloc] init];</div><div class="line">        return beitai;</div><div class="line">    &#125; else &#123;</div><div class="line">        return [super forwardingTargetForSelector:aSelector];</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>这么一来，就好像<code>HCBase</code>继承了<code>HCBeitai</code>一样，可以用来模拟多重继承。来看看运行的结果：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">// forwardingTarget</div><div class="line">[baseOBJ needForwardTarget];</div></pre></td></tr></table></figure>
<p><img src="/lionheart/1706/forwarding1.png" alt="forwarding1"></p>
<h4 id="完整的消息转发"><a href="#完整的消息转发" class="headerlink" title="完整的消息转发"></a>完整的消息转发</h4><blockquote>
<p><code>- (NSMethodSignature *)methodSignatureForSelector:(SEL)aSelector;</code></p>
<p><code>- (void)forwardInvocation:(NSInvocation *)invocation;</code></p>
</blockquote>
<p>当所有的手段都无法处理该方法时，就开启了完整的消息转发。先调用<code>methodSignatureForSelector</code>方法，给该未知方法签名— 类似<strong>@@:</strong> 。当签名不为空时，调用<code>forwardInvocation</code>，将位置方法的所有信息存放在<code>NSInvocation</code>对象中；这时可以更改方法的信息，比如selector，signature等等，然后交由其他对象来执行更改之后的方法。</p>
<p>来看看一个示例：<code>HCBase</code>声明了<code>needFinalForward</code>方法，但是没有提供实现；<code>HCBeitai</code>实现了<code>beitaiForwarding:</code>方法。消息转发，将给<code>HCBase</code>对象的<code>needFinalForward</code>方法 转发给了 <code>HCBeitai</code>对象的<code>beitaiForwarding:</code>方法。<strong>注意：这两个方法的selector和signature都不一样</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line">- (NSMethodSignature *)methodSignatureForSelector:(SEL)aSelector &#123;</div><div class="line">    NSLog(@&quot;vanney code log : selector is %@&quot;, NSStringFromSelector(aSelector));</div><div class="line">    NSMethodSignature *methodSignature = [super methodSignatureForSelector:aSelector];</div><div class="line">    if (!methodSignature) &#123;</div><div class="line">        NSLog(@&quot;vanney code log : inside create method signature&quot;);</div><div class="line">        methodSignature = [NSMethodSignature signatureWithObjCTypes:&quot;v@:i&quot;];</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    return methodSignature;</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (void)forwardInvocation:(NSInvocation *)anInvocation &#123;</div><div class="line">    NSLog(@&quot;vanney code log : forwarding invocation selector is %@&quot;, NSStringFromSelector(anInvocation.selector));</div><div class="line">    NSLog(@&quot;vanney code log : invocation is %@, and method signature is %@&quot;, anInvocation, anInvocation.methodSignature);</div><div class="line"></div><div class="line">    if (anInvocation.selector == @selector(needFinalForward)) &#123;</div><div class="line">        NSLog(@&quot;vanney code log : inside forwarding&quot;);</div><div class="line">        anInvocation.selector = NSSelectorFromString(@&quot;beitaiForwarding:&quot;);</div><div class="line">        int *a;</div><div class="line">        *a = 99;</div><div class="line">        [anInvocation setArgument:a atIndex:2];</div><div class="line">        HCBeiTai *beiTai = [[HCBeiTai alloc] init];</div><div class="line">        [anInvocation invokeWithTarget:beiTai];</div><div class="line">    &#125; else &#123;</div><div class="line">        NSLog(@&quot;vanney code log : else forwarding&quot;);</div><div class="line">        [super forwardInvocation:anInvocation];</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>转发的同时，还可以设置参数。把99传递给新的方法。来看看运行结果：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">// final forwarding</div><div class="line">[baseOBJ needFinalForward];</div></pre></td></tr></table></figure>
<p><img src="/lionheart/1706/forwarding2.png" alt="forwarding2"></p>
<h2 id="runtime应用"><a href="#runtime应用" class="headerlink" title="runtime应用"></a>runtime应用</h2><h3 id="Method-Swizzling"><a href="#Method-Swizzling" class="headerlink" title="Method Swizzling"></a>Method Swizzling</h3><p>可以在类的<code>load</code>方法中，通过<code>class_addMethod</code> <code>class_replaceMethod</code>来改变方法的默认实现方式。因为<code>load</code>方法执行时，所有类的方法都有了，但都还没有执行过一次</p>
<h3 id="JSON-gt-Model"><a href="#JSON-gt-Model" class="headerlink" title="JSON -&gt; Model"></a>JSON -&gt; Model</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div></pre></td><td class="code"><pre><div class="line">- (instancetype)initWithDict:(NSDictionary *)dict &#123;</div><div class="line"></div><div class="line">    if (self = [self init]) &#123;</div><div class="line">        //(1)获取类的属性及属性对应的类型</div><div class="line">        NSMutableArray * keys = [NSMutableArray array];</div><div class="line">        NSMutableArray * attributes = [NSMutableArray array];</div><div class="line">        /*</div><div class="line">         * 例子</div><div class="line">         * name = value3 attribute = T@&quot;NSString&quot;,C,N,V_value3</div><div class="line">         * name = value4 attribute = T^i,N,V_value4</div><div class="line">         */</div><div class="line">        unsigned int outCount;</div><div class="line">        objc_property_t * properties = class_copyPropertyList([self class], &amp;outCount);</div><div class="line">        for (int i = 0; i &lt; outCount; i ++) &#123;</div><div class="line">            objc_property_t property = properties[i];</div><div class="line">            //通过property_getName函数获得属性的名字</div><div class="line">            NSString * propertyName = [NSString stringWithCString:property_getName(property) encoding:NSUTF8StringEncoding];</div><div class="line">            [keys addObject:propertyName];</div><div class="line">            //通过property_getAttributes函数可以获得属性的名字和@encode编码</div><div class="line">            NSString * propertyAttribute = [NSString stringWithCString:property_getAttributes(property) encoding:NSUTF8StringEncoding];</div><div class="line">            [attributes addObject:propertyAttribute];</div><div class="line">        &#125;</div><div class="line">        //立即释放properties指向的内存</div><div class="line">        free(properties);</div><div class="line"></div><div class="line">        //(2)根据类型给属性赋值</div><div class="line">        for (NSString * key in keys) &#123;</div><div class="line">            if ([dict valueForKey:key] == nil) continue;</div><div class="line">            [self setValue:[dict valueForKey:key] forKey:key];</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    return self;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>该方法参考自<a href="http://www.jianshu.com/p/07b6c4a40a90" target="_blank" rel="external">[iOS] runtime 的使用场景–实战篇</a></p>
<h3 id="KVO-KVC"><a href="#KVO-KVC" class="headerlink" title="KVO, KVC"></a>KVO, KVC</h3><p>海带学习</p>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><ul>
<li><a href="http://www.jianshu.com/p/07b6c4a40a90" target="_blank" rel="external">[iOS] runtime 的使用场景–实战篇</a></li>
<li><a href="https://github.com/vanney9/runtime" target="_blank" rel="external">我的github</a></li>
</ul>

      
    </div>

    <div>
      
        

      
    </div>

    <div>
      
        

      
    </div>

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/iOS/" rel="tag">#iOS</a>
          
            <a href="/tags/runtime/" rel="tag">#runtime</a>
          
        </div>
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2017/06/09/objective-c-runtime-api/" rel="next" title="Objective-C runtime - API">
                <i class="fa fa-chevron-left"></i> Objective-C runtime - API
              </a>
            
          </div>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2017/06/10/objective-c-runtime-other/" rel="prev" title="Objective-C runtime - 如果还有其他的话">
                Objective-C runtime - 如果还有其他的话 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          
  <div class="comments" id="comments">
    
      <div class="ds-thread" data-thread-key="2017/06/10/objective-c-runtime-example/"
           data-title="Objective-C runtime - 应用和示例" data-url="http://yoursite.com/2017/06/10/objective-c-runtime-example/">
      </div>
    
  </div>


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap" >
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview sidebar-panel ">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/images/default_avatar.jpg"
               alt="Vanney" />
          <p class="site-author-name" itemprop="name">Vanney</p>
          <p class="site-description motion-element" itemprop="description"></p>
        </div>
        <nav class="site-state motion-element">
          <div class="site-state-item site-state-posts">
            <a href="/archives">
              <span class="site-state-item-count">52</span>
              <span class="site-state-item-name">日志</span>
            </a>
          </div>

          
            <div class="site-state-item site-state-categories">
              
                <span class="site-state-item-count">9</span>
                <span class="site-state-item-name">分类</span>
              
            </div>
          

          
            <div class="site-state-item site-state-tags">
              <a href="/tags">
                <span class="site-state-item-count">17</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/vanney9" target="_blank" title="GitHub">
                  
                    <i class="fa fa-fw fa-github"></i>
                  
                  GitHub
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="http://weibo.com/3911241332" target="_blank" title="Weibo">
                  
                    <i class="fa fa-fw fa-weibo"></i>
                  
                  Weibo
                </a>
              </span>
            
          
        </div>

        
        

        
        

      </section>

      
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">
            
              
            
            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#前言"><span class="nav-number">1.</span> <span class="nav-text">前言</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#几个有趣的示例"><span class="nav-number">2.</span> <span class="nav-text">几个有趣的示例</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#动态添加任意属性"><span class="nav-number">2.1.</span> <span class="nav-text">动态添加任意属性</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#添加属性"><span class="nav-number">2.1.1.</span> <span class="nav-text">添加属性</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#添加关联对象"><span class="nav-number">2.1.2.</span> <span class="nav-text">添加关联对象</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#访问属性"><span class="nav-number">2.1.3.</span> <span class="nav-text">访问属性</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#方法决议"><span class="nav-number">2.2.</span> <span class="nav-text">方法决议</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#消息转发"><span class="nav-number">2.3.</span> <span class="nav-text">消息转发</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#备援对象"><span class="nav-number">2.3.1.</span> <span class="nav-text">备援对象</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#完整的消息转发"><span class="nav-number">2.3.2.</span> <span class="nav-text">完整的消息转发</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#runtime应用"><span class="nav-number">3.</span> <span class="nav-text">runtime应用</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Method-Swizzling"><span class="nav-number">3.1.</span> <span class="nav-text">Method Swizzling</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#JSON-gt-Model"><span class="nav-number">3.2.</span> <span class="nav-text">JSON -> Model</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#KVO-KVC"><span class="nav-number">3.3.</span> <span class="nav-text">KVO, KVC</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#参考"><span class="nav-number">4.</span> <span class="nav-text">参考</span></a></li></ol></div>
            
          </div>
        </section>
      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2017</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Vanney</span>
</div>

<div class="powered-by">
  由 <a class="theme-link" href="https://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Mist
  </a>
</div>




        

        
      </div>
    </footer>

    <div class="back-to-top">
      <i class="fa fa-arrow-up"></i>
    </div>
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  



  
  <script type="text/javascript" src="/vendors/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/vendors/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/vendors/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/vendors/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/vendors/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/vendors/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.0.1"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.0.1"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.0.1"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.0.1"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.0.1"></script>



  

  
    
  

  <script type="text/javascript">
    var duoshuoQuery = {short_name:"vanney9"};
    (function() {
      var ds = document.createElement('script');
      ds.type = 'text/javascript';ds.async = true;
      ds.id = 'duoshuo-script';
      ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
      ds.charset = 'UTF-8';
      (document.getElementsByTagName('head')[0]
      || document.getElementsByTagName('body')[0]).appendChild(ds);
    })();
  </script>

  
    
    <script src="/vendors/ua-parser-js/dist/ua-parser.min.js?v=0.7.9"></script>
    <script src="/js/src/hook-duoshuo.js"></script>
  






  
  

  

  

  

</body>
</html>
